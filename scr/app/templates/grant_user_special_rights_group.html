{% extends "base.html" %}
{% block title %}üîí –í—ã–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∞{% endblock %}
{% block content %}
</br>
<h3>üîí –í—ã–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∞</h3>

<!-- –í—ã–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∞ –≤ –≥—Ä—É–ø–ø–µ -->
<label for="groups-select-privilage">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ–¥–∞—Ç—å –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∞:</label>
<select id="groups-select-privilage">
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
</select>

<label for="user-id-privilege">–í–≤–µ–¥–∏—Ç–µ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ß—Ç–æ –±—ã –ø–æ–ª—É—á–∏—Ç—å id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–æ–∂–µ—Ç–µ
    –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ / —á–∞—Ç–µ —Å –±–æ—Ç–æ–º, –∫–æ–º–∞–Ω–¥–æ–π /id. –ë–æ—Ç
    –æ—Ç–ø—Ä–∞–≤–∏—Ç id –≤ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞:</label>
<textarea id="user-id-privilege" rows="4" placeholder="–ü—Ä–∏–º–µ—Ä: 123456789"></textarea>


<!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram -->
<input type="hidden" id="user-id-field">


<br><br>
<button onclick="givePrivilege()">–î–∞—Ç—å –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∞</button>
<a href="/" class="btn">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>


<script>
    const tg = window.Telegram.WebApp;

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        tg.BackButton.show();

        tg.BackButton.onClick(() => {
            tg.expand();
            setTimeout(() => window.history.back(), 0);
        });

        const user = tg.initDataUnsafe?.user || {};
        const user_id = user.id;

        if (!user_id) {
            console.error("user_id –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram WebApp");
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º user_id –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        const hiddenField = document.getElementById("user-id-field");
        if (hiddenField) hiddenField.value = user_id;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –≥–ª–æ–±–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        window.TELEGRAM_USER_ID = user_id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        populateSelect(`/chat_title?user_id=${user_id}`, "groups-select-privilage");
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø
    async function populateSelect(url, selectId) {
        try {
            const response = await fetch(url);
            const data = await response.json();

            const select = document.getElementById(selectId);
            if (!select) return;

            data.groups.forEach((group) => {
                const option = document.createElement("option");
                option.value = group;
                option.textContent = group;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä—É–ø–ø:", error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–¥–∞—á–∏ –ø—Ä–∞–≤
    async function givePrivilege() {
        const chat_title = document.getElementById("groups-select-privilage").value.trim();
        const user_id = document.getElementById("user-id-privilege").value.trim();

        if (!chat_title || !user_id) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            return;
        }

        try {
            const body = new URLSearchParams({
                chat_title: chat_title,
                user_id: user_id,
            });

            const response = await fetch("give-privileges", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: body.toString(),
            });

            const result = await response.json();

            if (result.success) {
                alert(result.message || "–ü—Ä–∞–≤–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω—ã");
            } else {
                alert("–û—à–∏–±–∫–∞: " + (result.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å");
        }
    }
</script>


{% endblock %}