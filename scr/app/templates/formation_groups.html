{% extends "base.html" %}
{% block title %}üë• –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø{% endblock %}
{% block content %}
</br>
<h3>üë• –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø</h3>
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—à–∏–±–∫–µ -->
{% if request.query_params.success %}
<div class="status success">–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</div>
{% endif %} {% if request.query_params.error %}
<div class="status error">
    –û—à–∏–±–∫–∞: –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).
</div>
{% endif %}

<p>–≠—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≥—Ä—É–ø–ø.
<hr class="my-8 h-px border-0 bg-gray-300"/> –î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≥—Ä—É–ø–ø–∞–º–∏, –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å @username –≥—Ä—É–ø–ø—ã.</p>

<!--
  –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ ID –≥—Ä—É–ø–ø—ã. –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ /save-group
  –ü–æ–ª–µ <input> –∏–º–µ–µ—Ç –∞—Ç—Ä–∏–±—É—Ç name="chat_id"
  –ó–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–∞–∫ chat_id=... –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
  FastAPI –æ–∂–∏–¥–∞–µ—Ç –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º "chat_id" –∏–∑ —Ñ–æ—Ä–º—ã (name="chat_id")
  -->

<form action="/save-group" method="post" enctype="application/x-www-form-urlencoded">
    <label for="chat-username">–í–≤–µ–¥–∏—Ç–µ username –≥—Ä—É–ø–ø—ã –∏–ª–∏ –∫–∞–Ω–∞–ª–∞ –≤ –≤–∏–¥–µ @username:</label>
    <input type="text" id="chat-username" name="chat_username" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @username"/>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ user_id -->
    <input type="hidden" name="user_id" id="user-id-field">
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
</form>

<!-- –õ–∏–Ω–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
<hr class="my-8 h-px border-0 bg-gray-300"/>

<!-- –†–∞–∑–¥–µ–ª "–£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø" -->
<h3>–£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h3>
<p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–£–¥–∞–ª–∏—Ç—å¬ª</p>
<label for="group-select-del">–ì—Ä—É–ø–ø–∞:</label>
<select id="group-select-del">
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
</select>
<button onclick="delGroup()">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É</button>
<!-- –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
<p id="delete-status" class="status"></p>
<!-- –õ–∏–Ω–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->

<hr class="my-8 h-px border-0 bg-gray-300"/>
<a href="/" class="btn">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>

<!-- === –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript === -->


<script>
    const tg = window.Telegram.WebApp;

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        tg.BackButton.show();

        tg.BackButton.onClick(() => {
            tg.expand();
            setTimeout(() => window.history.back(), 0);
        });

        const user = tg.initDataUnsafe?.user || {};
        const user_id = user.id;

        if (!user_id) {
            console.error("user_id –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram WebApp");
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º user_id –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        document.getElementById("user-id-field").value = user_id;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –≥–ª–æ–±–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        window.TELEGRAM_USER_ID = user_id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        populateSelect(`/chat_title?user_id=${user_id}`, "group-select-del");
    });

    function populateSelect(url, selectId) {
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
            const groups = data.chat_title || data.groups || [];
            groups.forEach((group) => {
                const option = document.createElement("option");
                option.value = group.chat_title;
                option.textContent = group.chat_title;
                select.appendChild(option);
            });
        })
            .catch((err) => console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${selectId}:`, err));
    }

    async function delGroup() {
        const chat_title = document.getElementById("group-select-del").value.trim();
        if (!chat_title) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞");
            return;
        }

        try {
            const responseGetId = await fetch(`/get-chat-id?title=${encodeURIComponent(chat_title)}`);
            const data = await responseGetId.json();

            if (!data.success) {
                throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –≥—Ä—É–ø–ø—ã");
            }

            const chat_id = data.chat_id;
            const responseDelete = await fetch("/delete_group", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `chat_id=${chat_id}&user_id=${window.TELEGRAM_USER_ID}`,
            });

            const result = await responseDelete.json();
            const statusEl = document.getElementById("delete-status");

            if (result.success) {
                statusEl.innerText = `–ì—Ä—É–ø–ø–∞ "${chat_title}" —É–¥–∞–ª–µ–Ω–∞`;
                statusEl.className = "status success";
                populateSelect(`/chat_title?user_id=${window.TELEGRAM_USER_ID}`, "group-select-del");
            } else {
                statusEl.innerText = result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã";
                statusEl.className = "status error";
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            const statusEl = document.getElementById("delete-status");
            statusEl.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É";
            statusEl.className = "status error";
        }
    }
</script>

{% endblock %}