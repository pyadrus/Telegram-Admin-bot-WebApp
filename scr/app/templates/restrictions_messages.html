{% extends "base.html" %}
{% block title %}‚úâÔ∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è{% endblock %}
{% block content %}
</br>
<h3>‚úâÔ∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>

<!-- –°—Ç–∞—Ç—É—Å—ã -->
{% if request.query_params.success %}
<div class="status success">–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</div>
{% endif %}
{% if request.query_params.error %}
<div class="status error">–û—à–∏–±–∫–∞: –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).</div>
{% endif %}


<hr class="my-8 h-px border-0 bg-gray-300"/>

<!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π -->
<section>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –≤ –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ –≤–≤–µ—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</p>
    <label for="group-select">–ì—Ä—É–ø–ø–∞:</label>
    <select id="group-select">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
    </select>
    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <button onclick="setReadOnly()">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ</button>
    <button onclick="setFullAccess()">üîì –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–∏—Å–∞—Ç—å</button>
    <p id="delete-status" class="status"></p>
</section>

<hr class="my-8 h-px border-0 bg-gray-300"/>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
<a href="/" class="btn">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>


<script>
    const tg = window.Telegram.WebApp;

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        tg.BackButton.show();

        tg.BackButton.onClick(() => {
            setTimeout(() => window.history.back(), 0);
        });

        const user = tg.initDataUnsafe?.user || {};
        const user_id = user.id;

        if (!user_id) {
            console.error("user_id –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram WebApp");
            return;
        }

        window.TELEGRAM_USER_ID = user_id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
        populateSelect(`/chat_title?user_id=${user_id}`, "group-select");
    });

    function populateSelect(url, selectId) {
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
            const groups = data.chat_title || data.groups || [];
            groups.forEach((group) => {
                const option = document.createElement("option");
                option.value = group.chat_title;
                option.textContent = group.chat_title;
                select.appendChild(option);
            });
        })
            .catch((err) => console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${selectId}:`, err));
    }

    async function setReadOnly() {
        const chat_title = document.getElementById("group-select").value.trim();
        if (!chat_title) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É");

        try {
            const res = await fetch(`/get-chat-id?title=${encodeURIComponent(chat_title)}`);
            const data = await res.json();

            if (!data.success) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω ID –≥—Ä—É–ø–ø—ã");

            const response = await fetch(`/readonly?chat_id=${data.chat_id}`);
            const result = await response.json();

            alert(result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π");
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
            console.error(err);
        }
    }

    async function setFullAccess() {
        const chat_title = document.getElementById("group-select").value.trim();
        if (!chat_title) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É");

        try {
            const res = await fetch(`/get-chat-id?title=${encodeURIComponent(chat_title)}`);
            const data = await res.json();

            if (!data.success) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω ID –≥—Ä—É–ø–ø—ã");

            const response = await fetch(`/writeable?chat_id=${data.chat_id}`);
            const result = await response.json();

            alert(result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π");
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
            console.error(err);
        }
    }
</script>


{% endblock %}