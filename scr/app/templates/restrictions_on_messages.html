{% extends "base.html" %}
{% block title %}üë§ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤{% endblock %}
{% block content %}
</br>
<h3>üë§ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>

<label for="group-select">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:</label>
<select id="group-select">
    <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option>
</select>

<!-- —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è user_id -->
<input type="hidden" id="user-id-field" />

<button onclick="getParticipants()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
<p id="participants-count" class="status"></p>
<a href="/" class="btn">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>

<script>
    const tg = window.Telegram.WebApp;

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        tg.BackButton.show();

        tg.BackButton.onClick(() => {
            tg.expand();
            setTimeout(() => window.history.back(), 0);
        });

        const user = tg.initDataUnsafe?.user || {};
        const user_id = user.id;

        if (!user_id) {
            console.error("user_id –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram WebApp");
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º user_id –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        document.getElementById("user-id-field").value = user_id;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        window.TELEGRAM_USER_ID = user_id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        populateSelect(`/chat_title?user_id=${user_id}`, "group-select");
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –≥—Ä—É–ø–ø–∞–º–∏
    function populateSelect(url, selectId) {
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
                const groups = data.chat_title || data.groups || [];
                groups.forEach((group) => {
                    const option = document.createElement("option");
                    option.value = group.chat_title;
                    option.textContent = group.chat_title;
                    select.appendChild(option);
                });
            })
            .catch((err) => console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:`, err));
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    async function getParticipants() {
        const chat_title = document.getElementById("group-select").value.trim();
        if (!chat_title) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞");
            return;
        }

        try {
            const response = await fetch(
                `/update-participants?chat_title=${encodeURIComponent(chat_title)}`
            );
            const data = await response.json();
            const statusEl = document.getElementById("participants-count");

            if (data.success) {
                statusEl.innerText = `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${data.participants_count}`;
                statusEl.className = "status success";
            } else {
                throw new Error(data.error || "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            const statusEl = document.getElementById("participants-count");
            statusEl.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤";
            statusEl.className = "status error";
        }
    }
</script>

{% endblock %}
