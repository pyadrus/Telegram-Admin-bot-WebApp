{% extends "base.html" %}
{% block title %}üì¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–Ω–∞–ª{% endblock %}
{% block content %}
</br>
<h3>üì¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–Ω–∞–ª</h3>
<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h3>
<div class="section">
    <label for="groups-selected">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å:</label>
    <select id="groups-selected">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
    </select>
</div>

<label for="groups-selecteds">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É / –∫–∞–Ω–∞–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è:</label>
<select id="groups-selecteds">
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
</select>

<div class="section">
    <button onclick="toggleSubscriptionRequirement()">–í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
</div>

<div>
    <a href="/" class="button">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
</div>


<script>
    const tg = window.Telegram.WebApp;

    function populateSelect(url, selectId) {
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
            const groups = data.chat_title || data.groups || [];
            groups.forEach((group) => {
                const option = document.createElement("option");
                option.value = group.chat_title;
                option.textContent = group.chat_title;
                select.appendChild(option);
            });
        })
            .catch((err) => {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${selectId}:`, err);
        });
    }

    async function toggleSubscriptionRequirement() {
        const chat_title = document.getElementById("groups-selected").value.trim();
        const required_chat_title = document.getElementById("groups-selecteds").value.trim();

        if (!chat_title || !required_chat_title) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –≥—Ä—É–ø–ø—ã");
            return;
        }

        try {
            const response = await fetch(
                `/require-subscription?chat_title=${encodeURIComponent(chat_title)}&required_chat_title=${encodeURIComponent(required_chat_title)}`
            );
            const result = await response.json();

            if (result.success) {
                alert(result.message);
            } else {
                throw new Error(result.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        tg.expand();
        tg.BackButton.show();

        tg.BackButton.onClick(() => {
            setTimeout(() => window.history.back(), 0);
        });

        const user = tg.initDataUnsafe?.user || {};
        const user_id = user.id;

        if (!user_id) {
            console.error("user_id –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram WebApp");
            return;
        }

        window.TELEGRAM_USER_ID = user_id;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –≤ –æ–±–∞ select
        const url = `/chat_title?user_id=${user_id}`;
        populateSelect(url, "groups-selected");
        populateSelect(url, "groups-selecteds");
    });
</script>

{% endblock %}